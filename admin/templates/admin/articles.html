{% extends "admin/base.html" %}

{% block title %}Articles{% if zip_code %} - Zip {{ zip_code }}{% endif %}{% endblock %}

{% block content %}
<div id="articlesTab" class="tab-content">
    <div class="articles-list" id="articles-list" data-zip-code="{{ zip_code or '' }}" data-total-articles="{{ total_articles }}" data-rejected-count="{{ stats.rejected_articles if stats.rejected_articles else 0 }}">
        <div style="padding: 0.75rem 1rem; background: #1a1a1a; border-bottom: 2px solid #404040; font-weight: 600; color: #e0e0e0;">
            Showing {{ articles|length }} of {{ total_articles }} article{{ 's' if total_articles != 1 else '' }}{% if stats.rejected_articles > 0 %} ({{ stats.rejected_articles }} in <a href="/admin/{{ zip_code }}?tab=trash" style="color: #0078d4; text-decoration: underline;">üóëÔ∏è Trash</a>){% endif %}
        </div>
        {% for article in articles %}
        <div class="article-item {{ 'rejected' if article.get('is_rejected', 0) else '' }}" data-id="{{ article.id }}">
            <div class="article-info">
                <div class="article-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>{{ article.title[:80] }}{% if article.title|length > 80 %}...{% endif %}</span>
                    {% if article.url %}
                    <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" title="Open article in new window" style="color: #0078d4; text-decoration: none; font-size: 1.1rem; opacity: 0.7; transition: opacity 0.2s;">üîó</a>
                    {% endif %}
                </div>
                <div class="article-meta">
                    {{ article.source }} - {{ article.published[:10] if article.published else 'N/A' }}
                    {% if article.primary_category %}
                    ‚Ä¢ <span class="category-badge relevance-score-tooltip" data-article-id="{{ article.id }}" style="display: inline-block; padding: 0.2rem 0.5rem; background: #0078d4; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">
                        {{ article.primary_category }}{% if article.category_confidence %} {{ "%.0f"|format(article.category_confidence) }}%{% endif %}
                    </span>
                    {% elif article.category %}
                    ‚Ä¢ <span class="relevance-score-tooltip" data-article-id="{{ article.id }}">{{ article.category }}</span>
                    {% endif %}
                    {% if article.relevance_score is defined and article.relevance_score is not none %}
                    ‚Ä¢ <span class="relevance-score-tooltip" data-article-id="{{ article.id }}">Relevance: <strong style="color: {% if article.relevance_score >= 70 %}#4caf50{% elif article.relevance_score >= 40 %}#ff9800{% else %}#d32f2f{% endif %};">{{ "%.0f"|format(article.relevance_score) }}</strong>/100</span>
                    <span style="display: inline-block; width: 100px; height: 10px; background: #404040; border-radius: 5px; margin-left: 0.5rem; vertical-align: middle; overflow: hidden;">
                        <span style="display: block; width: {{ "%.0f"|format(article.relevance_score) }}%; height: 100%; background: {% if article.relevance_score >= 70 %}#4caf50{% elif article.relevance_score >= 40 %}#ff9800{% else %}#d32f2f{% endif %}; transition: width 0.3s;"></span>
                    </span>
                    {% else %}
                    ‚Ä¢ Relevance: N/A
                    {% endif %}
                    {% if article.local_score is defined and article.local_score is not none %}
                    ‚Ä¢ <span class="relevance-score-tooltip" data-article-id="{{ article.id }}">Local: <strong>{{ "%.0f"|format(article.local_score) }}</strong>/100</span>
                    <span style="display: inline-block; width: 100px; height: 10px; background: #404040; border-radius: 5px; margin-left: 0.5rem; vertical-align: middle; overflow: hidden;">
                        <span style="display: block; width: {{ "%.0f"|format(article.local_score) }}%; height: 100%; background: #4caf50; transition: width 0.3s;"></span>
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="article-actions" style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="relevance-breakdown-btn" data-id="{{ article.id }}" data-action="show-breakdown"
                        style="padding: 0.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;" 
                        title="Why rejected? / Score breakdown">
                    üìä
                </button>
                <button class="thumbs-up-btn" data-id="{{ article.id }}" data-state="{{ 'on' if article.get('is_good_fit', 0) else 'off' }}" data-action="thumbs-up"
                        style="padding: 0.5rem; background: {% if article.get('is_good_fit', 0) %}#4caf50{% else %}transparent{% endif %}; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; opacity: {% if article.get('is_good_fit', 0) %}1{% else %}0.5{% endif %}; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center;" 
                        title="Thumbs up (train relevance + category)">
                    üëç
                </button>
                <button class="thumbs-down-btn" data-id="{{ article.id }}" data-action="thumbs-down"
                        style="padding: 0.5rem; background: transparent; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; opacity: 0.5; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center;" 
                        title="Thumbs down (train relevance + category)">
                    üëé
                </button>
                <button class="top-story-btn" data-id="{{ article.id }}" data-state="{{ 'on' if article.get('is_top_story', 0) else 'off' }}" data-action="toggle-top-story"
                        style="padding: 0.5rem; background: {% if article.get('is_top_story', 0) %}#ff9800{% else %}transparent{% endif %}; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; opacity: {% if article.get('is_top_story', 0) %}1{% else %}0.5{% endif %}; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center;"
                        title="Mark as top story (perfect example)">
                    üé©
                </button>
                <button class="top-article-btn" data-id="{{ article.id }}" data-state="{{ 'on' if article.get('is_top', 0) else 'off' }}" data-action="toggle-top-article"
                        style="padding: 0.5rem; background: {% if article.get('is_top', 0) %}#ffd700{% else %}transparent{% endif %}; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; opacity: {% if article.get('is_top', 0) %}1{% else %}0.5{% endif %}; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center;"
                        title="Mark as top article (featured)">
                    ‚≠ê
                </button>
                <button class="alert-btn" data-id="{{ article.id }}" data-state="{{ 'on' if article.get('is_alert', 0) else 'off' }}" data-action="toggle-alert"
                        style="padding: 0.5rem; background: {% if article.get('is_alert', 0) %}#ff4444{% else %}transparent{% endif %}; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; opacity: {% if article.get('is_alert', 0) %}1{% else %}0.5{% endif %}; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center;"
                        title="Mark as alert (urgent notification)">
                    üö®
                </button>
                <button class="on-target-btn" data-id="{{ article.id }}" data-state="{{ 'on' if article.get('is_on_target') == 1 else 'off' }}" data-action="on-target"
                        style="padding: 0.5rem; background: {% if article.get('is_on_target') == 1 %}#4caf50{% else %}transparent{% endif %}; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; opacity: {% if article.get('is_on_target') == 1 %}1{% else %}0.5{% endif %}; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                        title="Mark as on target (relevant for targeting)">
                    üéØ
                </button>
                <button class="off-target-btn" data-id="{{ article.id }}" data-state="{{ 'on' if article.get('is_on_target') is not none and article.get('is_on_target') == 0 else 'off' }}" data-action="off-target"
                        style="padding: 0.5rem; background: {% if article.get('is_on_target') is not none and article.get('is_on_target') == 0 %}#f44336{% else %}transparent{% endif %}; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1rem; opacity: {% if article.get('is_on_target') is not none and article.get('is_on_target') == 0 %}1{% else %}0.5{% endif %}; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                        title="Mark as off target (not relevant for targeting)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <button class="edit-article-btn" data-id="{{ article.id }}" data-action="edit-article"
                        style="padding: 0.5rem; background: #252525; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;"
                        title="Edit article">
                    ‚úèÔ∏è
                </button>
                {% if not article.get('is_rejected', 0) %}
                <button class="trash-btn" data-id="{{ article.id }}" data-action="trash-article"
                        title="Move to trash" style="padding: 0.5rem; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;">üóëÔ∏è</button>
                {% else %}
                <button class="restore-trash-btn" data-id="{{ article.id }}" data-action="restore-article"
                        title="Restore from trash" style="padding: 0.5rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem;">‚Ü©Ô∏è</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if articles|length < total_articles %}
        <div style="text-align: center; padding: 2rem; border-top: 1px solid #404040;">
            <button id="loadMoreBtn" data-offset="{{ articles|length }}" data-zip-code="{{ zip_code }}" data-show-trash="{{ 'true' if show_trash else 'false' }}"
                    style="padding: 0.75rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Load More Articles ({{ total_articles - articles|length }} remaining)
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- Relevance Breakdown Modal -->
    <div id="relevanceBreakdownModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 2000; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: #111; color: #e0e0e0; max-width: 640px; width: 100%; border-radius: 10px; padding: 1.5rem; box-shadow: 0 12px 32px rgba(0,0,0,0.45); position: relative;">
            <button id="relevanceBreakdownClose" style="position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer;">‚úï</button>
            <h3 style="margin-top: 0; margin-bottom: 0.5rem; color: #fff;">Relevance breakdown</h3>
            <div id="relevanceBreakdownBody" style="max-height: 420px; overflow-y: auto; line-height: 1.5; font-size: 0.95rem;"></div>
        </div>
    </div>
</div>


<script>
// Article management functions are now handled in admin.js
</script>
{% endblock %}

