{% extends "admin/base.html" %}

{% block title %}Categories{% if zip_code %} - Zip {{ zip_code }}{% endif %}{% endblock %}

{% block content %}
<style>
/* Override any light theme CSS for categories page */
#categoriesTab .stat-card,
#categoriesTab div[style*="background"],
#categoriesTab div[style*="color"] {
    background: #1a1a1a !important;
    color: #ffffff !important;
    border-color: #404040 !important;
}

/* Ensure category stats cards are visible */
#categoryStats div {
    background: #1a1a1a !important;
    color: #ffffff !important;
    border: 1px solid #404040 !important;
}

#categoryStats h4 {
    color: #ffffff !important;
}

#categoryStats strong {
    color: #ffffff !important;
}

/* Override any inherited light backgrounds */
#categoriesTab * {
    color: inherit;
}
</style>

<div id="categoriesTab" class="tab-content active">
    <div class="relevance-container">
        <h2 style="margin-bottom: 1.5rem; text-align: center;">Category Classification System</h2>
        
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196f3; border-radius: 8px; position: relative; max-width: 1000px; margin-left: auto; margin-right: auto;">
            <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" data-toggle="categoriesExplanation">
                <h3 style="margin: 0; color: #ffffff;">üìö How Category Classification Works</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span id="categoriesExplanationToggle" style="font-size: 1.2rem; user-select: none; color: #ffffff;">‚ñº</span>
                </div>
            </div>
            <div id="categoriesExplanation" style="margin-top: 1rem; color: #cccccc; font-size: 0.95rem; line-height: 1.8; display: none;">
                <p style="margin: 0 0 1rem 0;">
                    <strong>Fast Keyword-Based + Bayesian Learning:</strong> This system uses a sophisticated two-stage approach to automatically categorize articles into the appropriate sections of your news site.
                </p>
                <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: #ffffff;">Two-Stage Classification:</h4>
                <ul style="margin: 0.5rem 0 1rem 0; padding-left: 1.5rem; color: #cccccc;">
                    <li style="margin-bottom: 0.5rem;"><strong>Stage 1 - Category Mapping:</strong> Articles with explicit category fields (news, sports, entertainment, etc.) are first mapped to category slugs using the CATEGORY_MAPPING system. For example, "news" and "local" both map to "local-news", while "entertainment" maps to "events".</li>
                    <li style="margin-bottom: 0.5rem;"><strong>Stage 2 - Keyword Matching:</strong> If an article doesn't have a category field or the mapping doesn't match the target category, the system searches the article's title and content for category-specific keywords. Each category has a curated list of keywords (e.g., "crime" category looks for: crime, police, arrest, suspect, investigation, charges, court, trial, criminal).</li>
                </ul>
                <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: #ffffff;">Category Slugs:</h4>
                <p style="margin: 0.5rem 0 1rem 0; color: #cccccc;">
                    The system uses URL-friendly category slugs (local-news, crime, sports, events, business, schools, food, obituaries) that map to user-friendly display names. These slugs are used in the website URLs and navigation, making the site structure clean and organized.
                </p>
                <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: #ffffff;">Keyword Lists:</h4>
                <p style="margin: 0.5rem 0 1rem 0; color: #cccccc;">
                    Each category has a carefully curated list of keywords that help identify relevant articles. For example, the "crime" category includes keywords like: crime, police, arrest, suspect, investigation, charges, court, trial, criminal. The "sports" category includes: sport, football, basketball, baseball, hockey, athlete, game, team, player. These keywords are matched against both the article title and content to determine the best category fit.
                </p>
                <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: #ffffff;">Automatic Processing:</h4>
                <p style="margin: 0.5rem 0 0 0; color: #cccccc;">
                    When articles are ingested, they're automatically categorized using this system. You can manually recategorize articles or use the "Recategorize All Articles" button to reprocess all articles with updated keyword lists. The system also supports Bayesian learning to improve categorization accuracy over time based on your corrections.
                </p>
            </div>
        </div>
        
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(255, 152, 0, 0.1); border-left: 4px solid #ff9800; border-radius: 8px; max-width: 1000px; margin-left: auto; margin-right: auto;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #ffffff;">Recalculate All Category Data</h3>
            <button style="padding: 0.75rem 1.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üîÑ Recalculate All Category Data</button>
            <p style="margin-top: 0.5rem; color: #cccccc; font-size: 0.9rem;">
                Updates categories, primary categories, category confidence, and local focus scores for all articles based on current keywords and training data. This is the most comprehensive option and replaces the need for separate "Retrain" and "Recategorize" buttons.
            </p>
            <p style="margin-top: 0.5rem; color: #aaaaaa; font-size: 0.85rem; font-style: italic;">
                ‚è±Ô∏è Estimated time: ~3-30 seconds depending on article count (typically under 15 seconds for 200-500 articles).
            </p>
        </div>
        
        <!-- Keyword Management Section -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #1a1a1a; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); max-width: 1000px; margin-left: auto; margin-right: auto;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #ffffff;">üîë Category Keywords</h3>
            <p style="color: #cccccc; font-size: 0.9rem; margin-bottom: 1.5rem;">
                Manage keywords for each category. Click the üóëÔ∏è icon to delete keywords.
            </p>

                <!-- Category Keywords List -->
            <div id="categoriesKeywordsList" style="max-width: none; margin: 0 auto;">
                <p style="color: #cccccc; text-align: center; margin: 2rem 0;">Loading categories...</p>
            </div>
        </div>

        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #1a1a1a; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); max-width: 1000px; margin-left: auto; margin-right: auto;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #ffffff;">Category Statistics</h3>
            <div id="categoryStats" style="padding: 1rem; background: #252525; border-radius: 4px;">
                <p style="color: #cccccc; text-align: center;">Loading statistics...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentCategory = '';
let keywordsCache = {};

// Load all categories and their keywords
async function loadAllCategoryKeywords() {
    const container = document.getElementById('categoriesKeywordsList');
    container.innerHTML = '<p style="color: #cccccc; text-align: center; margin: 2rem 0;">Loading categories...</p>';

    try {
        // Load keywords for all categories
        const categories = ['business', 'crime', 'events', 'food', 'local-news', 'obituaries', 'schools', 'sports', 'weather'];
        const categoriesData = [];

        for (const category of categories) {
            try {
                const response = await fetch(`/admin/api/category-keywords-full/${category}?zip_code={{ zip_code }}`);
                const data = await response.json();
                if (data.success) {
                    categoriesData.push({
                        name: category,
                        displayName: category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        keywords: data.keywords || []
                    });
                }
            } catch (error) {
                console.error(`Error loading keywords for ${category}:`, error);
                categoriesData.push({
                    name: category,
                    displayName: category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    keywords: []
                });
            }
        }

        displayAllCategories(categoriesData);
    } catch (error) {
        console.error('Error loading category keywords:', error);
        container.innerHTML = '<p style="color: #d32f2f; text-align: center; margin: 2rem 0;">Error loading categories</p>';
    }
}

// Display all categories with their keywords
function displayAllCategories(categoriesData) {
    const container = document.getElementById('categoriesKeywordsList');
    container.innerHTML = '';

    categoriesData.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.style.cssText = 'margin-bottom: 2rem; padding: 1.5rem; background: #252525; border-radius: 8px; border: 1px solid #404040; max-width: 700px; margin-left: auto; margin-right: auto;';

        // Category header with add keyword input
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #404040; padding-bottom: 0.5rem;';

        const header = document.createElement('h4');
        header.textContent = category.displayName;
        header.style.cssText = 'margin: 0; color: #ffffff; font-size: 1.1rem;';
        headerDiv.appendChild(header);

        // Add keyword input for this category
        const addDiv = document.createElement('div');
        addDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center;';

        const addInput = document.createElement('input');
        addInput.type = 'text';
        addInput.placeholder = 'Add keyword';
        addInput.style.cssText = 'padding: 0.25rem 0.5rem; border: 1px solid #404040; border-radius: 3px; background: #1a1a1a; color: #ffffff; font-size: 0.8rem; width: 120px;';
        addInput.setAttribute('data-category', category.name);

        // Add enter key support
        addInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addKeywordToCategory(category.name, addInput.value.trim());
            }
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = '+';
        addBtn.style.cssText = 'padding: 0.25rem 0.5rem; background: #4caf50; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem;';
        addBtn.onclick = () => addKeywordToCategory(category.name, addInput.value.trim());

        addDiv.appendChild(addInput);
        addDiv.appendChild(addBtn);
        headerDiv.appendChild(addDiv);
        categoryDiv.appendChild(headerDiv);

        // Keywords container
        const keywordsContainer = document.createElement('div');
        keywordsContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; margin-top: 1rem;';

        if (category.keywords && category.keywords.length > 0) {
            category.keywords.forEach(keyword => {
                const keywordTag = document.createElement('div');
                keywordTag.style.cssText = 'display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; font-size: 0.9rem; color: #cccccc; transition: all 0.2s ease;';

                const keywordText = document.createElement('span');
                keywordText.textContent = keyword;
                keywordTag.appendChild(keywordText);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.style.cssText = 'background: none; border: none; color: #ff4444; cursor: pointer; font-size: 0.9rem; padding: 0; margin-left: 0.25rem; transition: color 0.2s ease;';
                deleteBtn.onmouseover = () => deleteBtn.style.color = '#ff6666';
                deleteBtn.onmouseout = () => deleteBtn.style.color = '#ff4444';
                deleteBtn.onclick = () => deleteKeyword(category.name, keyword);
                keywordTag.appendChild(deleteBtn);

                keywordsContainer.appendChild(keywordTag);
            });
        } else {
            const noKeywords = document.createElement('div');
            noKeywords.textContent = 'No keywords yet - add some above!';
            noKeywords.style.cssText = 'color: #888; font-style: italic; text-align: center; width: 100%; padding: 1rem;';
            keywordsContainer.appendChild(noKeywords);
        }

        categoryDiv.appendChild(keywordsContainer);
        container.appendChild(categoryDiv);
    });
}

// Add a keyword to a specific category
async function addKeywordToCategory(category, keyword) {
    keyword = keyword.toLowerCase();

    if (!keyword) {
        showMessage('Please enter a keyword', 'error');
        return;
    }

    try {
        const response = await fetch('/admin/api/category-keyword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                category: category,
                keyword: keyword,
                zip_code: '{{ zip_code }}'
            })
        });

        const data = await response.json();

        if (data.success) {
            // Clear the input field
            const input = document.querySelector(`input[data-category="${category}"]`);
            if (input) input.value = '';

            // Reload all categories
            await loadAllCategoryKeywords();
            showMessage(`Keyword "${keyword}" added to ${category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}!`, 'success');
        } else {
            showMessage('Error adding keyword: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error adding keyword:', error);
        showMessage('Error adding keyword', 'error');
    }
}

// Delete a keyword from a category
async function deleteKeyword(category, keyword) {
    if (!confirm(`Are you sure you want to delete "${keyword}" from ${category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}?`)) {
        return;
    }

    try {
        const response = await fetch('/admin/api/category-keyword', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                category: category,
                keyword: keyword,
                zip_code: '{{ zip_code }}'
            })
        });

        const data = await response.json();

        if (data.success) {
            // Reload all categories
            await loadAllCategoryKeywords();
            showMessage('Keyword deleted successfully!', 'success');
        } else {
            showMessage('Error deleting keyword: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error deleting keyword:', error);
        showMessage('Error deleting keyword', 'error');
    }
}

// Show message to user
function showMessage(message, type) {
    // Remove existing messages
    const existing = document.querySelector('.message-notification');
    if (existing) existing.remove();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-notification';
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 4px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    `;

    if (type === 'success') {
        messageDiv.style.background = '#4caf50';
    } else {
        messageDiv.style.background = '#f44336';
    }

    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Toggle explanation visibility
function toggleExplanation(explanationId) {
    const element = document.getElementById(explanationId);
    const toggle = document.getElementById(explanationId + 'Toggle');

    if (element && toggle) {
        if (element.style.display === 'none') {
            element.style.display = 'block';
            toggle.textContent = '‚ñº';
        } else {
            element.style.display = 'none';
            toggle.textContent = '‚ñ∂';
        }
    }
}

// Close explanation
function closeExplanation(explanationId) {
    const element = document.getElementById(explanationId);
    const toggle = document.getElementById(explanationId + 'Toggle');

    if (element && toggle) {
        element.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

// Recalculate all category data
async function recalculateCategoryInfo() {
    const button = document.querySelector('button');
    const originalText = button.textContent;
    const startTime = Date.now();

    // Disable button and show initial loading with time estimate
    button.disabled = true;
    button.textContent = 'üîÑ Starting recalculation... (~15-30 seconds)';
    button.style.opacity = '0.7';

    // Show progress message
    showMessage('Starting category data recalculation...', 'info');

    try {
    // Show step-by-step progress with more detail
    setTimeout(() => {
        if (button.disabled) { // Only update if still processing
            button.textContent = 'üîÑ Loading article data... (2s)';
            showMessage('üìÇ Loading article database for analysis...', 'info');
        }
    }, 2000);

    setTimeout(() => {
        if (button.disabled) {
            button.textContent = 'üîÑ Analyzing categories... (8s)';
            showMessage('üß† Analyzing article categories and classifications...', 'info');
        }
    }, 8000);

    setTimeout(() => {
        if (button.disabled) {
            button.textContent = 'üîÑ Updating keyword matches... (15s)';
            showMessage('üîó Updating keyword-to-category matching algorithms...', 'info');
        }
    }, 15000);

    setTimeout(() => {
        if (button.disabled) {
            button.textContent = 'üîÑ Finalizing updates... (22s)';
            showMessage('üíæ Saving updated category data to database...', 'info');
        }
    }, 22000);

        const response = await fetch('/admin/api/recalculate-categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();
        const endTime = Date.now();
        const duration = Math.round((endTime - startTime) / 1000);

        if (data.success) {
            // Show prominent completion message
            showMessage(`üéâ RECALCULATION COMPLETE! ‚úÖ`, 'success');

            // Reload the page data
            await loadCategoryStats();
            await loadAllCategoryKeywords();

            // Show detailed stats prominently after a short delay
            if (data.stats) {
                const stats = data.stats;
                setTimeout(() => {
                    const completionMessage = `üìä Results: ${stats.articles_processed} articles processed, ${stats.categories_updated} categories updated in ${stats.processing_time_seconds} seconds`;
                    showMessage(completionMessage, 'success');

                    // Add a visual indicator to the page
                    showRecalculationResults(stats);
                }, 1500);
            }
        } else {
            showMessage('‚ùå Error recalculating categories: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error recalculating categories:', error);
        const endTime = Date.now();
        const duration = Math.round((endTime - startTime) / 1000);
        showMessage(`‚ùå Recalculation failed after ${duration} seconds: ${error.message}`, 'error');
    } finally {
        // Re-enable button
        button.disabled = false;
        button.textContent = originalText;
        button.style.opacity = '1';
    }
}

// Show recalculation results prominently on the page
function showRecalculationResults(stats) {
    // Remove any existing results display
    const existingResults = document.getElementById('recalcResults');
    if (existingResults) {
        existingResults.remove();
    }

    // Create results display element
    const resultsDiv = document.createElement('div');
    resultsDiv.id = 'recalcResults';
    resultsDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #1a1a1a;
        border: 2px solid #4caf50;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        z-index: 10000;
        max-width: 400px;
        text-align: center;
        animation: fadeIn 0.5s ease-out;
    `;

    resultsDiv.innerHTML = `
        <div style="font-size: 2rem; margin-bottom: 1rem;">üéâ</div>
        <h3 style="color: #4caf50; margin: 0 0 1rem 0; font-size: 1.5rem;">Recalculation Complete!</h3>
        <div style="color: #cccccc; line-height: 1.6;">
            <div style="font-size: 1.1rem; font-weight: bold; color: #ffffff; margin-bottom: 1rem;">
                ${stats.articles_processed} articles processed
            </div>
            <div style="margin-bottom: 0.5rem;">
                <strong style="color: #ffffff;">${stats.categories_updated}</strong> categories updated
            </div>
            <div style="margin-bottom: 0.5rem;">
                <strong style="color: #ffffff;">${stats.processing_time_seconds}s</strong> total time
            </div>
            <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #888;">
                ${stats.zip_code || 'All locations'}
            </div>
        </div>
        <button onclick="this.parentElement.remove()" style="
            background: #4caf50;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        ">OK</button>
    `;

    document.body.appendChild(resultsDiv);

    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (resultsDiv.parentElement) {
            resultsDiv.remove();
        }
    }, 8000);
}

// Enter key support is now handled inline for each category input

// #region agent log
function debugLog(message, data = {}) {
    fetch('http://127.0.0.1:7242/ingest/9497b7ee-78b4-45c5-99fd-3c5b05e85c0a', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            location: 'admin/templates/admin/categories.html',
            message: message,
            data: data,
            timestamp: Date.now(),
            sessionId: 'debug-session',
            runId: 'run1',
            hypothesisId: 'B'
        })
    }).catch(() => {});
}
// #endregion

// Load category statistics and keywords on page load
document.addEventListener('DOMContentLoaded', function() {
    // #region agent log
    debugLog('DOMContentLoaded fired', {
        url: window.location.href,
        userAgent: navigator.userAgent,
        readyState: document.readyState
    });
    // #endregion
    loadCategoryStats();
    loadAllCategoryKeywords();

    // Attach event listeners after DOM is loaded
    attachEventListeners();
});

// Attach event listeners to buttons and interactive elements
function attachEventListeners() {
    // Recalc button - find by text content since we removed the onclick attribute
    const buttons = document.querySelectorAll('button');
    console.log('[DEBUG] Found', buttons.length, 'buttons total');
    const recalcButton = Array.from(buttons).find(btn => btn.textContent.includes('Recalculate'));
    console.log('[DEBUG] Recalc button found:', !!recalcButton);
    if (recalcButton) {
        recalcButton.addEventListener('click', function() {
            console.log('[DEBUG] Recalc button clicked!');
            recalculateCategoryInfo();
        });
        console.log('[DEBUG] Recalc button event listener attached');
    } else {
        console.log('[DEBUG] Recalc button not found - button texts:', Array.from(buttons).map(btn => btn.textContent));
    }

    // Explanation toggle (header div)
    const explanationToggle = document.querySelector('[data-toggle="categoriesExplanation"]');
    if (explanationToggle) {
        explanationToggle.addEventListener('click', function() {
            toggleExplanation('categoriesExplanation');
        });
    }

}

// #region agent log
// Add instrumentation to key DOM elements
window.addEventListener('load', function() {
    debugLog('Window loaded', {
        categoryStats_element: !!document.getElementById('categoryStats'),
        keywordManagement_element: !!document.getElementById('keywordManagement'),
        categorySelect_element: !!document.getElementById('categorySelect'),
        newKeyword_element: !!document.getElementById('newKeyword'),
        keywordList_element: !!document.getElementById('keywordList')
    });
});
// #endregion

async function loadCategoryStats() {
    // #region agent log
    debugLog('loadCategoryStats called', {
        zip_code: '{{ zip_code }}',
        url: `/admin/api/category-keywords/{{ zip_code }}/stats`
    });
    // #endregion

    try {
        const response = await fetch(`/admin/api/category-keywords/{{ zip_code }}/stats`);
        // #region agent log
        debugLog('API response received', {
            status: response.status,
            statusText: response.statusText,
            url: response.url
        });
        // #endregion

        const data = await response.json();
        // #region agent log
        debugLog('API data parsed', {
            success: data.success,
            stats_count: data.stats ? data.stats.length : 0,
            error: data.error
        });
        // #endregion

        if (data.success) {
            displayCategoryStats(data.stats);
        }
    } catch (error) {
        // #region agent log
        debugLog('Error in loadCategoryStats', {
            error: error.message,
            stack: error.stack
        });
        // #endregion
        console.error('Error loading category stats:', error);
    }
}

function displayCategoryStats(stats) {
    // #region agent log
    debugLog('displayCategoryStats called', {
        stats_count: stats ? stats.length : 0,
        stats_sample: stats && stats.length > 0 ? stats[0] : null,
        statsDiv_exists: !!document.getElementById('categoryStats')
    });
    // #endregion

    const statsDiv = document.getElementById('categoryStats');

    if (!stats || stats.length === 0) {
        // #region agent log
        debugLog('No stats to display, showing empty message');
        // #endregion
        statsDiv.innerHTML = '<p style="color: #cccccc; text-align: center; margin: 0;">No category data available</p>';
        return;
    }

    // #region agent log
    debugLog('Generating HTML for stats', {
        first_stat: stats[0]
    });
    // #endregion

    let html = '<div style="display: grid !important; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important; gap: 1.5rem !important; background: transparent !important; max-width: 1000px; margin: 0 auto; justify-items: center;">';

    stats.forEach(stat => {
        html += `
            <div style="background: #1a1a1a !important; padding: 1rem; border-radius: 6px; border: 1px solid #404040 !important; color: #ffffff !important;">
                <h4 style="margin: 0 0 0.5rem 0; color: #ffffff !important;">${stat.name}</h4>
                <div style="font-size: 0.9rem; color: #cccccc !important;">
                    <div>Articles: <strong style="color: #ffffff !important;">${stat.article_count}</strong></div>
                    <div>Last 7 days: <strong style="color: #ffffff !important;">${stat.recent_count}</strong></div>
                    <div>Keywords: <strong style="color: #ffffff !important;">${stat.keyword_count}</strong></div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    // #region agent log
    debugLog('Setting innerHTML', {
        html_length: html.length,
        first_100_chars: html.substring(0, 100)
    });
    // #endregion
    statsDiv.innerHTML = html;

    // #region agent log
    debugLog('innerHTML set, checking result', {
        new_innerHTML_length: statsDiv.innerHTML.length,
        contains_business: statsDiv.innerHTML.includes('Business')
    });
    // #endregion
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
</style>

{% endblock %}

