{% extends "admin/base.html" %}

{% block title %}Stats{% if zip_code %} - Zip {{ zip_code }}{% endif %}{% endblock %}

{% block content %}
<div id="statsTab" class="tab-content">
    <div class="stats-container">
        <h2 style="margin-bottom: 1.5rem;">Statistics Dashboard</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_articles }}</div>
                <div class="stat-label">Total Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.active_articles }}</div>
                <div class="stat-label">Active Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.rejected_articles }}</div>
                <div class="stat-label">Rejected Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.top_stories }}</div>
                <div class="stat-label">Top Stories</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.featured_articles }}</div>
                <div class="stat-label">Featured Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.articles_last_7_days }}</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <div class="stats-section">
                <h3>Articles by Source</h3>
                <div class="stats-list">
                    {% for item in stats.articles_by_source %}
                    <div class="stats-item">
                        <span class="stats-item-label">{{ item.source }}</span>
                        <span class="stats-item-value">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="stats-section">
                <h3>Articles by Category</h3>
                <div class="stats-list">
                    {% for item in stats.articles_by_category %}
                    <div class="stats-item">
                        <span class="stats-item-label">{{ item.category }}</span>
                        <span class="stats-item-value">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        {% if stats.categories_detail %}
        <div class="stats-section" style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem;">Category Details with Keywords</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                {% for cat in stats.categories_detail %}
                <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1a1a1a; font-size: 1.1rem;">{{ cat.category }}</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #666; font-size: 0.9rem;">Articles:</span>
                        <span style="font-weight: 600; color: #2196f3;">{{ cat.article_count }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #666; font-size: 0.9rem;">Keywords:</span>
                        <span style="font-weight: 600; color: #4caf50;">{{ cat.keyword_count }}</span>
                    </div>
                    <div style="padding-top: 0.75rem; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 0.85rem; color: #888; margin-bottom: 0.25rem;">Sample Keywords:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                            {% for keyword in cat.keywords[:8] %}
                            <span style="padding: 0.2rem 0.5rem; background: #f5f5f5; border-radius: 4px; font-size: 0.8rem; color: #555;">{{ keyword }}</span>
                            {% endfor %}
                            {% if cat.keywords|length > 8 %}
                            <span style="padding: 0.2rem 0.5rem; background: #f5f5f5; border-radius: 4px; font-size: 0.8rem; color: #888;">+{{ cat.keywords|length - 8 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if stats.source_fetch_stats %}
        <div class="stats-section" style="margin-top: 2rem;">
            <h3>Source Fetch Status</h3>
            <div class="stats-list">
                {% for item in stats.source_fetch_stats %}
                <div class="stats-item">
                    <span class="stats-item-label">{{ item.source }}</span>
                    <span class="stats-item-value">{{ item.count }} articles</span>
                    <span class="stats-item-meta">Last: {{ item.last_fetch[:16] if item.last_fetch else 'Never' }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Database Statistics Section -->
        {% if db_stats %}
        <div class="stats-section" style="margin-top: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 2rem;">
            <h2 style="color: white; margin-bottom: 1.5rem; text-align: center;">üóÑÔ∏è Database Health & Statistics</h2>

            <!-- Database Info -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.database_info.size_mb }} MB</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Database Size</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.database_info.tables }}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Tables</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.health_stats.data_completeness }}%</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Data Completeness</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.ai_ml_stats.training_samples }}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">AI Training Samples</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Article Stats -->
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üìä Article Statistics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Total Articles:</strong> {{ db_stats.article_stats.total | number_format }}</div>
                        <div><strong>With Images:</strong> {{ db_stats.article_stats.with_images | number_format }} ({{ db_stats.article_stats.image_percentage }}%)</div>
                        <div><strong>Last 7 Days:</strong> {{ db_stats.article_stats.recent_7_days | number_format }}</div>
                        <div><strong>Relevance Score:</strong> {{ db_stats.article_stats.relevance_scores.avg }} ({{ db_stats.article_stats.relevance_scores.min }}-{{ db_stats.article_stats.relevance_scores.max }})</div>
                    </div>
                </div>

                <!-- AI/ML Stats -->
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">ü§ñ AI/ML Systems</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Relevance Rules:</strong> {{ db_stats.ai_ml_stats.relevance_rules | number_format }}</div>
                        <div><strong>Training Samples:</strong> {{ db_stats.ai_ml_stats.training_samples | number_format }}</div>
                        <div><strong>Good Fit:</strong> {{ db_stats.ai_ml_stats.good_fit_samples | number_format }}</div>
                        <div><strong>Bad Fit:</strong> {{ db_stats.ai_ml_stats.bad_fit_samples | number_format }}</div>
                    </div>
                </div>
            </div>

            <!-- Source Breakdown -->
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üì∞ Top Content Sources</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                    {% for source in db_stats.source_stats.top_sources %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ source.source }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ source.count | number_format }} articles ({{ source.percentage }}%)</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Category Breakdown -->
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üè∑Ô∏è Content Categories</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
                    {% for cat in db_stats.category_stats.breakdown %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ cat.category | title }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ cat.count | number_format }} articles ({{ cat.percentage }}%)</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Management & Performance -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">‚öôÔ∏è Article Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Total Entries:</strong> {{ db_stats.management_stats.total_entries | number_format }}</div>
                        <div><strong>Enabled:</strong> {{ db_stats.management_stats.enabled | number_format }} ({{ db_stats.management_stats.enabled_percentage }}%)</div>
                        <div><strong>Disabled:</strong> {{ db_stats.management_stats.disabled | number_format }}</div>
                        <div><strong>Posted:</strong> {{ db_stats.performance_stats.posted_articles | number_format }}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üíö Database Health</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Duplicate URLs:</strong> {{ db_stats.health_stats.duplicate_urls | number_format }}</div>
                        <div><strong>Missing Zip Codes:</strong> {{ db_stats.health_stats.articles_without_zip | number_format }}</div>
                        <div><strong>Missing Categories:</strong> {{ db_stats.health_stats.articles_without_category | number_format }}</div>
                        <div><strong>Missing Relevance:</strong> {{ db_stats.health_stats.articles_without_relevance | number_format }}</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(76, 175, 80, 0.2); border-radius: 4px; border-left: 3px solid #4caf50;">
                        <strong>‚úÖ Data Quality:</strong> {{ db_stats.health_stats.data_completeness }}% complete
                    </div>
                </div>
            </div>

            <!-- Zip Code Stats -->
            {% if db_stats.zip_stats.breakdown %}
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üìç Geographic Coverage</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem;">
                    {% for zip in db_stats.zip_stats.breakdown %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px; text-align: center;">
                        <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.25rem;">{{ zip.zip }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ zip.count | number_format }} articles</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">{{ zip.percentage }}%</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- AI Rule Categories -->
            {% if db_stats.ai_ml_stats.rule_categories %}
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üéØ AI Relevance Rules</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
                    {% for rule in db_stats.ai_ml_stats.rule_categories %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ rule.category | title }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ rule.count | number_format }} rules</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

