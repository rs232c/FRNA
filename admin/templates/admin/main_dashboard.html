{% extends "admin/base.html" %}

{% block title %}{% if is_main_admin %}Main Admin Dashboard{% elif zip_code %}Zip {{ zip_code }} Dashboard{% else %}Admin Dashboard{% endif %}{% endblock %}

{% block content %}
{% if is_main_admin_view %}
<style>
/* Light theme overrides for main admin */
body { background: #f5f5f5 !important; color: #333 !important; }
.header { background: #ffffff !important; color: #333 !important; border-bottom: 1px solid #ddd !important; }
.header a { color: #0078d4 !important; }
.controls { background: #ffffff !important; border: 1px solid #e9ecef !important; }
.articles-list { background: #ffffff !important; border: 1px solid #e9ecef !important; }
.settings-container { background: #ffffff !important; border: 1px solid #e9ecef !important; }
.settings-section { background: #f8f9fa !important; border: 1px solid #e9ecef !important; }
.tabs { border-bottom-color: #e9ecef !important; }
.tab-btn { color: #6c757d !important; }
.article-item { border-bottom-color: #e9ecef !important; }
.zip-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
.zip-card { background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; text-align: center; transition: box-shadow 0.2s; }
.zip-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.zip-code { font-size: 1.5rem; font-weight: bold; color: #0078d4; margin-bottom: 0.5rem; }
.zip-link { display: inline-block; padding: 0.5rem 1rem; background: #0078d4; color: white; text-decoration: none; border-radius: 4px; transition: background 0.2s; }
.zip-link:hover { background: #0056b3; }
</style>
{% endif %}

<!-- OVERVIEW TAB (Global Dashboard) -->
<!-- DEBUG: zip_code='{{ zip_code }}', is_main_admin={{ is_main_admin }} -->
{% if not zip_code and is_main_admin %}
<div id="overviewTab" class="tab-content{% if active_tab == 'overview' %} active{% endif %}">
    <div class="container">
        <h2 style="margin-bottom: 2rem;">Global Admin Dashboard</h2>

        <div class="stats-grid" style="margin-bottom: 3rem;">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_articles or 0 }}</div>
                <div class="stat-label">Total Articles (All Zips)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.published_today or 0 }}</div>
                <div class="stat-label">Published Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ enabled_zips|length }}</div>
                <div class="stat-label">Active Zip Codes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.rejected_articles or 0 }}</div>
                <div class="stat-label">Rejected Articles</div>
            </div>
        </div>

        <h3 style="margin-bottom: 1.5rem;">Manage Zip Code Dashboards</h3>
        <p style="color: #666; margin-bottom: 2rem;">Click on any zip code below to access its individual admin dashboard.</p>

        <div class="zip-grid">
            {% for zip in enabled_zips %}
            <div class="zip-card">
                <div class="zip-code">{{ zip }}</div>
                <a href="/admin/{{ zip }}" class="zip-link">Manage {{ zip }}</a>
            </div>
            {% endfor %}
        </div>

        <div style="margin-top: 3rem; padding: 2rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <h3>Quick Actions</h3>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button onclick="regenerateWebsite()" style="padding: 0.75rem 1.5rem;">Regenerate All Sites</button>
                <button onclick="regenerateAll()" style="background: #ff9800; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px;">üîÑ Full Data Refresh</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div id="articlesTab" class="tab-content{% if active_tab == 'articles' or not active_tab %} active{% endif %}">
    <div class="articles-list" id="articles-list" data-zip-code="{{ zip_code or '' }}" data-total-articles="{{ total_count }}" data-rejected-count="{{ stats.rejected_articles if stats.rejected_articles else 0 }}">
        <div style="padding: 0.75rem 1rem; background: #1a1a1a; border-bottom: 2px solid #404040; font-weight: 600; color: #e0e0e0;">
            Showing {{ articles|length }} of {{ total_count }} article{{ 's' if total_count != 1 else '' }}
        </div>
        {% for article in articles %}
        <div class="article-item {{ 'rejected' if article.get('is_rejected', 0) else ('auto-filtered' if article.get('is_auto_filtered', 0) else '') }}"
             data-id="{{ article.id }}"
             style="background: {% if article.get('is_auto_filtered', 0) %}rgba(147, 51, 234, 0.1){% else %}#1a1a1a{% endif %};
                    border: 1px solid {% if article.get('is_auto_filtered', 0) %}#9333ea{% else %}#404040{% endif %};
                    border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;
                    opacity: {% if article.get('is_rejected', 0) %}0.6{% else %}1{% endif %};
                    transition: all 0.2s ease;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <h3 style="color: #ffffff; font-size: 1rem; font-weight: 600; margin: 0; line-height: 1.3;">{{ article.title[:100] }}{% if article.title|length > 100 %}...{% endif %}</h3>
                        {% if article.url %}
                        <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" style="color: #60a5fa; text-decoration: none; font-size: 1.1rem;">üîó</a>
                        {% endif %}
                    </div>

                    <div style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        {{ article.source }} ‚Ä¢ {{ article.published[:16] if article.published else 'N/A' }}
                        {% if article.primary_category %}
                        ‚Ä¢ <span style="background: #2563eb; color: white; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                            {{ article.primary_category }}{% if article.category_confidence %} {{ "%.0f"|format(article.category_confidence) }}%{% endif %}
                        </span>
                        {% endif %}
                    </div>

                    <div style="display: flex; gap: 1.5rem; font-size: 0.875rem;">
                        {% if article.relevance_score is defined and article.relevance_score is not none %}
                        <div>
                            <span style="color: #9ca3af;">Relevance:</span>
                            <span style="color: {% if article.relevance_score >= 70 %}#10b981{% elif article.relevance_score >= 40 %}#f59e0b{% else %}#ef4444{% endif %}; font-weight: 600;">
                                {{ "%.0f"|format(article.relevance_score) }}/100
                            </span>
                        </div>
                        {% endif %}
                        {% if article.local_score is defined and article.local_score is not none %}
                        <div>
                            <span style="color: #9ca3af;">Local:</span>
                            <span style="color: #10b981; font-weight: 600;">{{ "%.0f"|format(article.local_score) }}/100</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div style="display: flex; gap: 0.375rem; align-items: center; flex-shrink: 0;">
                    <button onclick="showRelevanceBreakdown({{ article.id }})"
                            style="background: #2563eb; color: white; border: none; border-radius: 6px; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; transition: all 0.2s;"
                            title="Score breakdown">üìä</button>

                    <button onclick="adminAction({{ article.id }}, 'thumbs_up')"
                            style="background: {% if article.get('is_good_fit', 0) %}#10b981{% else %}transparent{% endif %}; color: white; border: 1px solid {% if article.get('is_good_fit', 0) %}#10b981{% else %}#6b7280{% endif %}; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: {% if article.get('is_good_fit', 0) %}1{% else %}0.6{% endif %}; transition: all 0.2s;"
                            title="Thumbs up (good fit)">üëç</button>

                    <button onclick="adminAction({{ article.id }}, 'thumbs_down')"
                            style="background: transparent; color: white; border: 1px solid #6b7280; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: all 0.2s;"
                            title="Thumbs down (bad fit)">üëé</button>

                    <button onclick="adminAction({{ article.id }}, 'top_story')"
                            style="background: {% if article.get('is_top_story', 0) %}#f59e0b{% else %}transparent{% endif %}; color: white; border: 1px solid {% if article.get('is_top_story', 0) %}#f59e0b{% else %}#6b7280{% endif %}; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: {% if article.get('is_top_story', 0) %}1{% else %}0.6{% endif %}; transition: all 0.2s;"
                            title="Top story">üé©</button>

                    <button onclick="adminAction({{ article.id }}, 'top_article')"
                            style="background: {% if article.get('is_top', 0) %}#fbbf24{% else %}transparent{% endif %}; color: white; border: 1px solid {% if article.get('is_top', 0) %}#fbbf24{% else %}#6b7280{% endif %}; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: {% if article.get('is_top', 0) %}1{% else %}0.6{% endif %}; transition: all 0.2s;"
                            title="Featured">‚≠ê</button>

                    <button onclick="adminAction({{ article.id }}, 'alert')"
                            style="background: {% if article.get('is_alert', 0) %}#ef4444{% else %}transparent{% endif %}; color: white; border: 1px solid {% if article.get('is_alert', 0) %}#ef4444{% else %}#6b7280{% endif %}; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: {% if article.get('is_alert', 0) %}1{% else %}0.6{% endif %}; transition: all 0.2s;"
                            title="Alert">üö®</button>

                    <button onclick="adminAction({{ article.id }}, 'on_target')"
                            style="background: {% if article.get('is_on_target') == 1 %}#10b981{% else %}transparent{% endif %}; color: white; border: 1px solid {% if article.get('is_on_target') == 1 %}#10b981{% else %}#6b7280{% endif %}; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: {% if article.get('is_on_target') == 1 %}1{% else %}0.6{% endif %}; transition: all 0.2s;"
                            title="On target">üéØ</button>

                    <button onclick="adminAction({{ article.id }}, 'off_target')"
                            style="background: {% if article.get('is_on_target') is not none and article.get('is_on_target') == 0 %}#ef4444{% else %}transparent{% endif %}; color: white; border: 1px solid {% if article.get('is_on_target') is not none and article.get('is_on_target') == 0 %}#ef4444{% else %}#6b7280{% endif %}; border-radius: 50%; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: {% if article.get('is_on_target') is not none and article.get('is_on_target') == 0 %}1{% else %}0.6{% endif %}; transition: all 0.2s;"
                            title="Off target">‚ùå</button>

                    {% if article.get('is_rejected', 0) %}
                    <button onclick="adminAction({{ article.id }}, 'restore')"
                            style="background: {% if article.get('is_auto_filtered', 0) %}#9333ea{% else %}#10b981{% endif %}; color: white; border: none; border-radius: 6px; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                            title="Restore">‚Ü©Ô∏è</button>
                    {% else %}
                    <button onclick="adminAction({{ article.id }}, 'trash')"
                            style="background: #ef4444; color: white; border: none; border-radius: 6px; width: 2rem; height: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                            title="Trash">üóëÔ∏è</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if articles|length < total_count %}
        <div style="text-align: center; padding: 2rem; border-top: 1px solid #404040;">
            <button id="loadMoreBtn" data-offset="{{ articles|length }}" data-zip-code="{{ zip_code }}" data-show-trash="{{ 'true' if show_trash else 'false' }}"
                    style="padding: 0.75rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Load More Articles ({{ total_count - articles|length }} remaining)
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Relevance Breakdown Modal -->
    <div id="relevanceBreakdownModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 2000; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: #111; color: #e0e0e0; max-width: 640px; width: 100%; border-radius: 10px; padding: 1.5rem; box-shadow: 0 12px 32px rgba(0,0,0,0.45); position: relative;">
            <button id="relevanceBreakdownClose" style="position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer;">‚úï</button>
            <h3 style="margin-top: 0; margin-bottom: 0.5rem; color: #fff;">Relevance breakdown</h3>
            <div id="relevanceBreakdownBody" style="max-height: 420px; overflow-y: auto; line-height: 1.5; font-size: 0.95rem;"></div>
        </div>
    </div>
</div>


<!-- SOURCES TAB -->
{% if active_tab == 'sources' %}
<div id="sourcesTab" class="tab-content{% if active_tab == 'sources' %} active{% endif %}">
    <div class="sources-list">
        {% if sources|length == 0 %}
        <div style="padding: 2rem; text-align: center; background: #252525; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #404040;">
            <p style="color: #666; margin-bottom: 1rem;">No sources configured for this zip code.</p>
            <button onclick="addNewSource()" style="padding: 0.75rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                + Add Source
            </button>
        </div>
        {% else %}
        {% for source_key, source_config in sources.items() %}
        <div class="source-item">
            <div class="source-info">
                <div class="source-name">{{ source_config.name }}</div>
                <div class="source-url">{{ source_config.url }}</div>
                <div class="source-category">Category: {{ source_config.get('category', 'news') }}</div>
                {% if source_config.get('_relevance_score') is not none and source_config.get('_relevance_score') >= 0 %}
                <div class="source-relevance" style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">
                    Relevance Score: <strong style="color: {% if source_config.get('_relevance_score', 0) >= 20 %}#4caf50{% elif source_config.get('_relevance_score', 0) >= 10 %}#ff9800{% else %}#f44336{% endif %};">{{ "%.1f"|format(source_config.get('_relevance_score')) }}</strong> points
                </div>
                {% else %}
                <div class="source-relevance" style="color: #999; font-size: 0.9rem; margin-top: 0.25rem; font-style: italic;">
                    No relevance score set
                </div>
                {% endif %}
            </div>
            <div class="source-actions">
                <button class="edit-source-btn" data-source-key="{{ source_key }}" title="Edit source">‚úèÔ∏è</button>
                <div class="toggle-switch">
                    <label>Enabled:</label>
                    <label class="switch">
                        <input type="checkbox" class="source-enabled" data-source="{{ source_key }}" {{ 'checked' if source_config.get('enabled', True) else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-switch">
                    <label>Require Fall River:</label>
                    <label class="switch">
                        <input type="checkbox" class="source-filter" data-source="{{ source_key }}" {{ 'checked' if source_config.get('require_fall_river', False) else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        {% endfor %}
        <div style="margin-top: 1.5rem;">
            <button onclick="addNewSource()" style="padding: 0.75rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                + Add Source
            </button>
        </div>
        {% endif %}
    </div>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
        <p style="color: #666; font-size: 0.9rem;">
            <strong>Note:</strong> "Require Fall River" means only articles mentioning "Fall River" will be included from that source.
            This helps filter out irrelevant content from larger regional sources like Fun107 and WPRI.
        </p>
    </div>
</div>
{% endif %}

<!-- STATS TAB -->
{% if active_tab == 'stats' %}
<div id="statsTab" class="tab-content{% if active_tab == 'stats' %} active{% endif %}">
    <div class="stats-container">
        <h2 style="margin-bottom: 1.5rem;">Statistics Dashboard</h2>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_articles }}</div>
                <div class="stat-label">Total Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.active_articles }}</div>
                <div class="stat-label">Active Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.rejected_articles }}</div>
                <div class="stat-label">Rejected Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.top_stories }}</div>
                <div class="stat-label">Top Stories</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.disabled_articles }}</div>
                <div class="stat-label">Disabled Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.articles_last_7_days }}</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <div class="stats-section">
                <h3>Articles by Source</h3>
                <div class="stats-list">
                    {% for item in stats.articles_by_source %}
                    <div class="stats-item">
                        <span class="stats-item-label">{{ item.source }}</span>
                        <span class="stats-item-value">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="stats-section">
                <h3>Articles by Category</h3>
                <div class="stats-list">
                    {% for item in stats.articles_by_category %}
                    <div class="stats-item">
                        <span class="stats-item-label">{{ item.category }}</span>
                        <span class="stats-item-value">{{ item.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% if stats.source_fetch_stats %}
        <div class="stats-section" style="margin-top: 2rem;">
            <h3>Source Fetch Status</h3>
            <div class="stats-list">
                {% for item in stats.source_fetch_stats %}
                <div class="stats-item">
                    <span class="stats-item-label">{{ item.source }}</span>
                    <span class="stats-item-value">{{ item.count }} articles</span>
                    <span class="stats-item-meta">Last: {{ item.last_fetch[:16] if item.last_fetch else 'Never' }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Database Statistics Section -->
        {% if db_stats %}
        <div class="stats-section" style="margin-top: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 2rem;">
            <h2 style="color: white; margin-bottom: 1rem; text-align: center; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 8px; display: inline-block;">üóÑÔ∏è Database Health & Interactive Management</h2>

            <!-- Management Legend -->
            <div style="background: rgba(255,255,255,0.1); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="color: white; margin-bottom: 0.75rem; font-size: 1.1rem;">üéØ Click any card below to manage:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; font-size: 0.9rem; line-height: 1.4;">
                    <div style="background: rgba(0, 255, 136, 0.15); padding: 0.5rem; border-radius: 4px; border: 1px solid rgba(0, 255, 136, 0.3);"><strong style="color: #00ff88;">ü§ñ AI Rules:</strong> Keywords that boost or filter articles</div>
                    <div style="background: rgba(0, 255, 136, 0.15); padding: 0.5rem; border-radius: 4px; border: 1px solid rgba(0, 255, 136, 0.3);"><strong style="color: #00ff88;">üì∞ Source Credibility:</strong> Trust scores for news outlets</div>
                    <div style="background: rgba(0, 255, 136, 0.15); padding: 0.5rem; border-radius: 4px; border: 1px solid rgba(0, 255, 136, 0.3);"><strong style="color: #00ff88;">üè∑Ô∏è Category Keywords:</strong> Auto-classification helpers</div>
                </div>
            </div>

            <!-- Database Info -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.database_info.size_mb }} MB</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Database Size</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.database_info.tables }}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Tables</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.health_stats.data_completeness }}%</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Data Completeness</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">{{ db_stats.ai_ml_stats.training_samples }}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">AI Training Samples</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Article Stats -->
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üìä Article Statistics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Total Articles:</strong> {{ db_stats.article_stats.total }}</div>
                        <div><strong>With Images:</strong> {{ db_stats.article_stats.with_images }} ({{ db_stats.article_stats.image_percentage }}%)</div>
                        <div><strong>Last 7 Days:</strong> {{ db_stats.article_stats.recent_7_days }}</div>
                        <div><strong>Relevance Score:</strong> {{ db_stats.article_stats.relevance_scores.avg }} ({{ db_stats.article_stats.relevance_scores.min }}-{{ db_stats.article_stats.relevance_scores.max }})</div>
                    </div>
                </div>

                <!-- AI/ML Stats -->
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">ü§ñ AI/ML Systems</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Relevance Rules:</strong> {{ db_stats.ai_ml_stats.relevance_rules }}</div>
                        <div><strong>Training Samples:</strong> {{ db_stats.ai_ml_stats.training_samples }}</div>
                        <div><strong>Good Fit:</strong> {{ db_stats.ai_ml_stats.good_fit_samples }}</div>
                        <div><strong>Bad Fit:</strong> {{ db_stats.ai_ml_stats.bad_fit_samples }}</div>
                    </div>
                </div>
            </div>

            <!-- Source Breakdown -->
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üì∞ Source Credibility Scores</h3>
                <div style="margin-bottom: 1rem; font-size: 0.95rem; line-height: 1.4; background: rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 6px; border-left: 4px solid #00ff88;">
                    Adjust trust scores for news sources. Higher scores (+5-25 pts) boost article rankings, lower scores reduce visibility.
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                    {% for source in db_stats.source_stats.top_sources %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onclick="if (typeof showSourceManager !== 'undefined') { showSourceManager('{{ source.source | e }}'); } else { console.error('showSourceManager function not found'); }">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ source.source }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ source.count }} articles ({{ source.percentage }}%)</div>
                        <div style="font-size: 0.9rem; margin-top: 0.25rem; color: #00ff88; font-weight: 600; background: rgba(0, 255, 136, 0.15); padding: 0.2rem 0.4rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(0, 255, 136, 0.3);">Click to adjust score ‚Üí</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Category Breakdown -->
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üè∑Ô∏è Category Keywords</h3>
                <div style="margin-bottom: 1rem; font-size: 0.95rem; line-height: 1.4; background: rgba(255,255,255,0.08); padding: 0.75rem; border-radius: 6px; border-left: 4px solid #00ff88;">
                    Add keywords to help the AI automatically classify articles into the correct categories for better organization.
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
                    {% for cat in db_stats.category_stats.breakdown %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onclick="if (typeof showCategoryManager !== 'undefined') { showCategoryManager('{{ cat.category | e }}'); } else { console.error('showCategoryManager function not found'); }">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ cat.category | title }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ cat.count }} articles ({{ cat.percentage }}%)</div>
                        <div style="font-size: 0.9rem; margin-top: 0.25rem; color: #00ff88; font-weight: 600; background: rgba(0, 255, 136, 0.15); padding: 0.2rem 0.4rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(0, 255, 136, 0.3);">Click to add keywords ‚Üí</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Management & Performance -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">‚öôÔ∏è Article Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Total Entries:</strong> {{ db_stats.management_stats.total_entries }}</div>
                        <div><strong>Enabled:</strong> {{ db_stats.management_stats.enabled }} ({{ db_stats.management_stats.enabled_percentage }}%)</div>
                        <div><strong>Disabled:</strong> {{ db_stats.management_stats.disabled }}</div>
                        <div><strong>Posted:</strong> {{ db_stats.performance_stats.posted_articles }}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px;">
                    <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üíö Database Health</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div><strong>Duplicate URLs:</strong> {{ db_stats.health_stats.duplicate_urls }}</div>
                        <div><strong>Missing Zip Codes:</strong> {{ db_stats.health_stats.articles_without_zip }}</div>
                        <div><strong>Missing Categories:</strong> {{ db_stats.health_stats.articles_without_category }}</div>
                        <div><strong>Missing Relevance:</strong> {{ db_stats.health_stats.articles_without_relevance }}</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(76, 175, 80, 0.2); border-radius: 4px; border-left: 3px solid #4caf50;">
                        <strong>‚úÖ Data Quality:</strong> {{ db_stats.health_stats.data_completeness }}% complete
                    </div>
                </div>
            </div>

            <!-- Zip Code Stats -->
            {% if db_stats.zip_stats.breakdown %}
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üìç Geographic Coverage</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem;">
                    {% for zip in db_stats.zip_stats.breakdown %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px; text-align: center;">
                        <div style="font-weight: bold; font-size: 1.2rem; margin-bottom: 0.25rem;">{{ zip.zip }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ zip.count }} articles</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">{{ zip.percentage }}%</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- AI Rule Categories -->
            {% if db_stats.ai_ml_stats.rule_categories %}
            <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                <h3 style="color: white; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">üéØ AI Relevance Rules</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
                    {% for rule in db_stats.ai_ml_stats.rule_categories %}
                    <div style="background: rgba(255,255,255,0.1); padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onclick="if (typeof showRuleManager !== 'undefined') { showRuleManager('{{ rule.category }}'); } else { console.error('showRuleManager function not found'); }">
                        <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ rule.category | title }}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">{{ rule.count }} rules</div>
                        {% if rule.category == 'high_relevance' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #00ff00; font-weight: 600; background: rgba(0, 255, 0, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(0, 255, 0, 0.3);">+10 pts: Fall River mentions</div>
                        {% elif rule.category == 'local_places' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #0088ff; font-weight: 600; background: rgba(0, 136, 255, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(0, 136, 255, 0.3);">+3 pts: Local landmarks</div>
                        {% elif rule.category == 'topic_keywords' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #ffaa00; font-weight: 600; background: rgba(255, 170, 0, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(255, 170, 0, 0.3);">+2-8 pts: News topics</div>
                        {% elif rule.category == 'medium_relevance' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #ffaa00; font-weight: 600; background: rgba(255, 170, 0, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(255, 170, 0, 0.3);">+5 pts: Regional content</div>
                        {% elif rule.category == 'excluded_towns' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #ff4444; font-weight: 600; background: rgba(255, 68, 68, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(255, 68, 68, 0.3);">0 pts: Filter nearby towns</div>
                        {% elif rule.category == 'clickbait_patterns' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #dd44ff; font-weight: 600; background: rgba(221, 68, 255, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(221, 68, 255, 0.3);">-50 pts: Spam detection</div>
                        {% elif rule.category == 'source_credibility' %}
                        <div style="font-size: 0.85rem; margin-top: 0.25rem; color: #8888ff; font-weight: 600; background: rgba(136, 136, 255, 0.2); padding: 0.25rem 0.5rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(136, 136, 255, 0.3);">+5-25 pts: Trust scores</div>
                        {% endif %}
                        <div style="font-size: 0.9rem; margin-top: 0.25rem; color: #00ff88; font-weight: 600; background: rgba(0, 255, 136, 0.15); padding: 0.2rem 0.4rem; border-radius: 3px; display: inline-block; border: 1px solid rgba(0, 255, 136, 0.3);">Click to manage ‚Üí</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Rule Management Modal -->
        <div id="ruleManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; padding: 2rem; box-sizing: border-box;">
            <div style="background: #252525; border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: white; margin: 0;">üéØ Manage <span id="ruleCategoryTitle">Rules</span></h2>
                    <button onclick="if (typeof closeRuleManager !== 'undefined') { closeRuleManager(); } else { console.error('closeRuleManager function not found'); }" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="ruleManagerInput" placeholder="Add new rule" style="flex: 1; padding: 0.75rem; border: 1px solid #555; border-radius: 4px; background: #1a1a1a; color: white; font-size: 1rem;">
                        <button onclick="if (typeof addRuleFromModal !== 'undefined') { addRuleFromModal(); } else { console.error('addRuleFromModal function not found'); }" style="padding: 0.75rem 1.5rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;">Add Rule</button>
                    </div>
                    <div style="margin-bottom: 0.5rem; color: #bbb; font-size: 0.9rem;">
                        Current rules in this category:
                    </div>
                    <div id="ruleManagerItems" style="display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 100px; padding: 1rem; background: #1a1a1a; border-radius: 4px; border: 1px solid #444; font-size: 0.9rem;">
                        <!-- Rules will be loaded here -->
                    </div>
                </div>

                <div style="text-align: right;">
                    <button onclick="if (typeof closeRuleManager !== 'undefined') { closeRuleManager(); } else { console.error('closeRuleManager function not found'); }" style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>

        <!-- Source Management Modal -->
        <div id="sourceManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; padding: 2rem; box-sizing: border-box;">
            <div style="background: #252525; border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: white; margin: 0;">üì∞ Adjust <span id="sourceNameTitle">Source</span> Credibility</h2>
                    <button onclick="closeSourceManager()" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #eee; margin-bottom: 1rem; font-size: 1rem; line-height: 1.5;">
                        <strong id="sourceArticleCount" style="color: #00ff88;">0</strong> articles from this source.
                        <br><strong style="color: #00ff88;">Credibility scores</strong> add +5 to +25 points to articles from trusted sources, helping them rank higher in your feed.
                        Higher scores = more visibility for this source's articles.
                    </p>

                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 4px; border: 1px solid #444;">
                        <h4 style="color: white; margin-bottom: 0.5rem;">Source Credibility Score</h4>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <input type="number" id="sourceCredibilityInput" min="0" max="100" step="1" style="padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #333; color: white; width: 100px;">
                            <button onclick="updateSourceCredibility()" style="padding: 0.5rem 1rem; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">Update Score</button>
                            <span style="color: #888; font-size: 0.9rem;">Current: <span id="currentCredibilityScore">25</span> points</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button onclick="closeSourceManager()" style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div id="categoryManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; padding: 2rem; box-sizing: border-box;">
            <div style="background: #252525; border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: white; margin: 0;">üè∑Ô∏è Add Keywords to <span id="categoryNameTitle">Category</span></h2>
                    <button onclick="closeCategoryManager()" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #eee; margin-bottom: 1rem; font-size: 1rem; line-height: 1.5;">
                        <strong id="categoryArticleCount" style="color: #00ff88;">0</strong> articles in this category.
                        <br><strong style="color: #00ff88;">Keywords</strong> help the AI automatically classify new articles into the correct categories.
                        Add relevant terms to improve article organization and filtering.
                    </p>

                    <div style="background: #1a1a1a; padding: 1rem; border-radius: 4px; border: 1px solid #444;">
                        <h4 style="color: white; margin-bottom: 0.5rem;">Category Keywords</h4>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="categoryKeywordInput" placeholder="Add keyword" style="flex: 1; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #333; color: white;">
                            <button onclick="addCategoryKeyword()" style="padding: 0.5rem 1rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
                        </div>
                        <div id="categoryKeywordsList" style="display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 50px; padding: 0.5rem; background: #333; border-radius: 4px;">
                            <!-- Keywords will be loaded here -->
                        </div>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button onclick="closeCategoryManager()" style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- RELEVANCE TAB -->
{% if active_tab == 'relevance' %}
<div id="relevanceTab" class="tab-content{% if active_tab == 'relevance' %} active{% endif %}">
    <div class="relevance-container">
        <h2 style="margin-bottom: 1.5rem; color: #e0e0e0;">Relevance Scoring Configuration</h2>

        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; position: relative;">
            <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleExplanation('bayesianExplanation')">
                <h3 style="margin: 0; color: white; font-size: 1.3rem;">üß† Bayesian Learning System</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span id="bayesianExplanationToggle" style="font-size: 1.2rem; user-select: none; color: white;">‚ñº</span>
                    <button onclick="event.stopPropagation(); closeExplanation('bayesianExplanation')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;" title="Close">√ó</button>
                </div>
            </div>
            <div id="bayesianExplanation" style="margin-top: 1rem; display: none;">
                <div style="color: white; font-size: 0.95rem; line-height: 1.8;">
                    <p style="margin: 0 0 1rem 0;">
                        The system uses a <strong>Naive Bayes classifier</strong> - a machine learning algorithm that learns from your article rejections to automatically filter similar content in the future. This intelligent system gets smarter over time as you curate your news feed.
                    </p>
                    <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: rgba(255,255,255,0.95);">How It Works:</h4>
                    <ul style="margin: 0.5rem 0 1rem 0; padding-left: 1.5rem;">
                        <li style="margin-bottom: 0.5rem;"><strong>Feature Extraction:</strong> When you reject an article, the system extracts key features including keywords (important nouns, verbs), nearby towns mentioned (Cape Cod, Tiverton, Somerset, etc.), topics/categories, and whether Fall River is mentioned.</li>
                        <li style="margin-bottom: 0.5rem;"><strong>Pattern Learning:</strong> The system stores these patterns in a database, tracking which features are associated with rejections vs. acceptances. It uses Laplace smoothing to handle new, unseen features gracefully.</li>
                        <li style="margin-bottom: 0.5rem;"><strong>Probability Calculation:</strong> For new articles, it calculates P(reject | features) - the probability that an article should be rejected based on its features. If this probability exceeds 70%, the article is automatically filtered.</li>
                        <li style="margin-bottom: 0.5rem;"><strong>Context Awareness:</strong> The system is smart enough to allow articles about nearby towns if they also mention Fall River or have high local relevance scores, even if the Bayesian model suggests rejection.</li>
                    </ul>
                    <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: rgba(255,255,255,0.95);">Activation:</h4>
                    <p style="margin: 0.5rem 0 1rem 0;">
                        The Bayesian learning system activates after you've rejected <strong>50 or more articles</strong>. Before that threshold, it's in training mode, learning patterns but not yet auto-filtering. Once active, it will automatically filter articles that match learned rejection patterns.
                    </p>
                    <h4 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; color: rgba(255,255,255,0.95);">Training:</h4>
                    <p style="margin: 0.5rem 0 0 0;">
                        Every time you click thumbs down or manually reject an article, the system extracts features and updates its model. The more you provide feedback, the better it gets at identifying similar unwanted content. You can view training statistics in the Stats tab.
                    </p>
                </div>
            </div>
        </div>

        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Auto-Filter Threshold</h3>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="font-weight: 600; color: #1a1a1a;">Minimum Relevance Score:</label>
                <input type="number" id="relevanceThreshold" value="{{ (settings.get('relevance_threshold', '10') | float) | int }}" step="1" min="0" max="100" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100px;">
                <button class="save-threshold-btn" style="padding: 0.5rem 1rem; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Save Threshold</button>
            </div>
        </div>

        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Rerun Relevance Scoring</h3>
            <p style="margin-bottom: 1rem; color: #1a1a1a;">
                Recalculate relevance scores for all existing articles using current relevance settings.
                Articles that fail the relevance threshold or Bayesian filtering will be automatically marked as auto-filtered.
            </p>
            <button id="rerunRelevanceBtn" onclick="rerunRelevanceScoring()" 
                    style="padding: 0.75rem 1.5rem; background: #ffc107; color: #1a1a1a; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                üîÑ Rerun Relevance Scoring on All Articles
            </button>
            <div id="rerunRelevanceStatus" style="margin-top: 1rem; display: none;">
                <p style="color: #1a1a1a; font-weight: 600;"></p>
            </div>
        </div>

        {% if relevance_config %}
        <!-- High Relevance Keywords -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #4caf50;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">High Relevance Keywords ({{ relevance_config.get('high_relevance_points', 15) }} points each)</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="highRelevanceInput" placeholder="Add keyword" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 300px; margin-right: 0.5rem;">
                <button onclick="addRelevanceItem('high_relevance', document.getElementById('highRelevanceInput').value)" style="padding: 0.5rem 1rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="highRelevanceItems">
                {% for item in relevance_config.get('high_relevance', []) %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #e8f5e9; border-radius: 4px;">
                    <span style="color: #1a1a1a;">{{ item }}</span>
                    <button class="remove-relevance-btn" data-category="high_relevance" data-item="{{ item|e }}" style="margin-left: 0.5rem; background: #f44336; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Medium Relevance Keywords -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #ff9800;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Medium Relevance Keywords (5 points each)</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="mediumRelevanceInput" placeholder="Add keyword" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 300px; margin-right: 0.5rem;">
                <button onclick="addRelevanceItem('medium_relevance', document.getElementById('mediumRelevanceInput').value)" style="padding: 0.5rem 1rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="mediumRelevanceItems">
                {% for item in relevance_config.get('medium_relevance', []) %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #fff3e0; border-radius: 4px;">
                    <span style="color: #1a1a1a;">{{ item }}</span>
                    <button class="remove-relevance-btn" data-category="medium_relevance" data-item="{{ item|e }}" style="margin-left: 0.5rem; background: #f44336; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Local Places -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #2196f3;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Local Places ({{ relevance_config.get('local_places_points', 3) }} points each)</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="localPlacesInput" placeholder="Add place" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 300px; margin-right: 0.5rem;">
                <button onclick="addRelevanceItem('local_places', document.getElementById('localPlacesInput').value)" style="padding: 0.5rem 1rem; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="localPlacesItems">
                {% for item in relevance_config.get('local_places', []) %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #e3f2fd; border-radius: 4px;">
                    <span style="color: #1a1a1a;">{{ item }}</span>
                    <button class="remove-relevance-btn" data-category="local_places" data-item="{{ item|e }}" style="margin-left: 0.5rem; background: #f44336; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Topic Keywords -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #9c27b0;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Topic Keywords (Custom Points)</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="topicKeywordInput" placeholder="Keyword" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 200px; margin-right: 0.5rem;">
                <input type="number" id="topicPointsInput" placeholder="Points" step="0.1" min="0" max="100" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100px; margin-right: 0.5rem;">
                <button onclick="addTopicKeyword()" style="padding: 0.5rem 1rem; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="topicKeywordsItems">
                {% for keyword, points in relevance_config.get('topic_keywords', {}).items() %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #f3e5f5; border-radius: 4px;">
                    <span style="color: #1a1a1a;"><strong>{{ keyword }}</strong>: {{ "%.1f"|format(points) }} pts</span>
                    <button class="remove-relevance-btn" data-category="topic_keywords" data-item="{{ keyword|e }}" style="margin-left: 0.5rem; background: #f44336; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Source Credibility -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #00bcd4;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Source Credibility (Points)</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="sourceInput" placeholder="Source name" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 200px; margin-right: 0.5rem;">
                <input type="number" id="sourcePointsInput" placeholder="Points" step="0.1" min="0" max="100" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100px; margin-right: 0.5rem;">
                <button onclick="addSourceCredibility()" style="padding: 0.5rem 1rem; background: #00bcd4; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="sourceCredibilityItems">
                {% for source, points in relevance_config.get('source_credibility', {}).items() %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #e0f7fa; border-radius: 4px;">
                    <span style="color: #1a1a1a;"><strong>{{ source }}</strong>: {{ "%.1f"|format(points) }} pts</span>
                    <button class="remove-relevance-btn" data-category="source_credibility" data-item="{{ source|e }}" style="margin-left: 0.5rem; background: #f44336; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Clickbait Patterns -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #f44336;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Clickbait Patterns (Negative Impact)</h3>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="clickbaitInput" placeholder="Add pattern" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 300px; margin-right: 0.5rem;">
                <button onclick="addRelevanceItem('clickbait_patterns', document.getElementById('clickbaitInput').value)" style="padding: 0.5rem 1rem; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="clickbaitPatternsItems">
                {% for item in relevance_config.get('clickbait_patterns', []) %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #ffebee; border-radius: 4px;">
                    <span style="color: #1a1a1a;">{{ item }}</span>
                    <button class="remove-relevance-btn" data-category="clickbait_patterns" data-item="{{ item|e }}" style="margin-left: 0.5rem; background: #d32f2f; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Excluded Towns -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #f44336;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">üö´ Excluded Towns (Auto-Filtered)</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                Towns on this list are automatically filtered out unless the article also mentions Fall River.
                Towns are added automatically when you reject articles about them.
            </p>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="excludedTownInput" placeholder="Add town (e.g., 'somerset')" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 300px; margin-right: 0.5rem;">
                <button onclick="addRelevanceItem('excluded_towns', document.getElementById('excludedTownInput').value)" style="padding: 0.5rem 1rem; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
            </div>
            <div class="relevance-items" id="excludedTownsItems">
                {% for item in relevance_config.get('excluded_towns', []) %}
                <div class="relevance-item" style="display: inline-block; margin: 0.25rem; padding: 0.5rem 1rem; background: #ffebee; border-radius: 4px;">
                    <span style="color: #1a1a1a;">{{ item }}</span>
                    <button class="remove-relevance-btn" data-category="excluded_towns" data-item="{{ item|e }}" style="margin-left: 0.5rem; background: #d32f2f; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">&#128465;&#65039;</button>
                </div>
                {% endfor %}
                {% if not relevance_config.get('excluded_towns') %}
                <p style="color: #888; font-style: italic;">No excluded towns yet. Reject articles about unwanted towns to add them here.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Bayesian Statistics -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: white;">üß† Bayesian Learning Statistics</h3>
            <div id="bayesianStats" style="color: white;">
                <p>Loading statistics...</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- CATEGORIES TAB -->
{% if active_tab == 'categories' %}
<div id="categoriesTab" class="tab-content{% if active_tab == 'categories' %} active{% endif %}">
    <div class="relevance-container">
        <h2 style="margin-bottom: 1.5rem;">Category Classification System</h2>

        <!-- Collapsible Explanation -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleExplanation('categoriesExplanation')">
                <h3 style="margin: 0; color: #333;">üìö How Category Classification Works</h3>
                <span id="categoriesExplanationToggle" style="font-size: 1.2rem; user-select: none;">‚è∑</span>
            </div>
            <div id="categoriesExplanation" style="margin-top: 1rem; color: #666; font-size: 0.9rem; line-height: 1.6;">
                <p><strong>Fast Keyword-Based + Bayesian Learning:</strong> This system uses a combination of keyword matching and machine learning to automatically categorize articles.</p>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                    <li><strong>Keyword Matching:</strong> Each category has a list of keywords. Articles are scored based on how many keywords they contain relative to article length.</li>
                    <li><strong>Bayesian Learning:</strong> As you give thumbs up/down feedback on article categories, the system learns patterns and improves accuracy.</li>
                    <li><strong>Cold-Start:</strong> For the first 48 hours or until you have 50+ training examples, the system uses pure keyword matching. After that, it switches to Bayesian-enhanced scoring.</li>
                    <li><strong>Training:</strong> Use the thumbs up/down buttons next to category badges on articles to train the system. The more you train, the smarter it gets!</li>
                </ul>
                <p style="margin-top: 0.5rem;"><strong>Result:</strong> After 50-100 training examples per zip code, the system achieves >95% accuracy with zero AI costs and <1ms prediction time.</p>
            </div>
        </div>

        <!-- Retrain All Categories -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #333;">Retrain All Categories</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                Recalculate categories for all articles using the current trained model and keyword lists.
                This is useful after training the classifier with new examples or updating keywords.
            </p>
            <button onclick="retrainAllCategories()" style="padding: 0.75rem 1.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                üîÑ Retrain All Categories
            </button>
        </div>

        <!-- Category Statistics -->
        <div class="relevance-section" style="margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 1rem; color: #333;">Category Statistics</h3>
            <div id="categoryStats" style="padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                {% if category_stats %}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    {% for cat in category_stats %}
                    <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #333;">{{ cat.name }}</h4>
                        <div style="font-size: 0.9rem; color: #666;">
                            <div>Articles: <strong>{{ cat.article_count }}</strong></div>
                            <div>Last 7 days: <strong>{{ cat.recent_count }}</strong></div>
                            <div>Keywords: <strong>{{ cat.keyword_count }}</strong></div>
                        </div>
                        {% if cat.keyword_count > 0 %}
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                            <div style="font-weight: 600; color: #555; margin-bottom: 0.25rem;">Sample Keywords:</div>
                            <div id="keywords-{{ cat.name|lower|replace(' ', '-') }}" style="font-style: italic;">
                                Loading...
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Load keyword samples -->
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    {% for cat in category_stats %}
                    {% if cat.keyword_count > 0 %}
                    fetch('/admin/api/category-keywords/{{ cat.name|lower|replace(' ', '-') }}?zip_code={{ zip_code }}')
                        .then(response => response.json())
                        .then(data => {
                            const container = document.getElementById('keywords-{{ cat.name|lower|replace(' ', '-') }}');
                            if (data.keywords && data.keywords.length > 0) {
                                container.textContent = data.keywords.slice(0, 5).join(', ') + (data.keywords.length > 5 ? '...' : '');
                            } else {
                                container.textContent = 'No keywords loaded';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading keywords for {{ cat.name }}:', error);
                            document.getElementById('keywords-{{ cat.name|lower|replace(' ', '-') }}').textContent = 'Error loading';
                        });
                    {% endif %}
                    {% endfor %}
                });
                </script>
                {% else %}
                <p style="color: #666; text-align: center;">No categories found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- SETTINGS TAB -->
{% if active_tab == 'settings' %}
<div id="settingsTab" class="tab-content{% if active_tab == 'settings' %} active{% endif %}">
    <div class="settings-container">
        <h2 style="margin-bottom: 1.5rem;">
            Settings
            {% if is_main_admin %}
                <span style="color: #0078d4; font-size: 0.8rem; font-weight: normal;"> (Main Admin - Global)</span>
            {% elif zip_code %}
                <span style="color: #ff9800; font-size: 0.8rem; font-weight: normal;"> (Zip {{ zip_code }})</span>
            {% endif %}
        </h2>

        <div class="settings-section">
            <h3>Website Regeneration</h3>
            <div class="settings-controls">
                <button onclick="regenerateWebsite()" style="margin-right: 1rem;">Regenerate Website</button>
                <button onclick="regenerateAll()" style="background: #ff9800; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üîÑ Regenerate All (Fresh Data)</button>
            </div>
            <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
                <strong>Regenerate Website:</strong> Regenerates using existing articles.<br>
                <strong>Regenerate All:</strong> Fetches fresh data and regenerates completely.
            </p>
        </div>

        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Auto-Regeneration Settings</h3>
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <label style="font-weight: 600;">Regeneration Interval (minutes):</label>
                <input type="number" id="regenerateInterval" value="{{ settings.get('regenerate_interval', '1') }}" min="1" max="1440" step="1" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100px;">
                <button onclick="toggleAutoRegenerate()" id="autoRegenerateToggle" style="padding: 0.5rem 1rem; background: {{ '#4caf50' if (settings.get('auto_regenerate') == '1' or settings.get('auto_regenerate') is none) else '#f44336' }}; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; min-width: 60px;">
                    {{ 'ON' if (settings.get('auto_regenerate') == '1' or settings.get('auto_regenerate') is none) else 'OFF' }}
                </button>
                <button onclick="saveRegenerateSettings()" style="padding: 0.5rem 1rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üíæ Save</button>
            </div>
            <p style="color: #666; font-size: 0.85rem;">
                Auto-regeneration runs the aggregation cycle every X minutes when enabled.
                <strong>Note:</strong> Restart main.py for changes to take effect.
            </p>
        </div>

        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Display Settings</h3>
            <div class="toggle-switch">
                <label>Show Images:</label>
                <label class="switch">
                    <input type="checkbox" id="showImagesSettings" {{ 'checked' if settings.get('show_images') == '1' else '' }}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Weather API Configuration</h3>
            <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #856404; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Get your free API key:</strong> Visit <a href="https://openweathermap.org/api" target="_blank" style="color: #0066cc;">https://openweathermap.org/api</a>
                </p>
            </div>
            <div style="margin-top: 1rem;">
                <label for="weatherApiKey" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">OpenWeatherMap API Key:</label>
                <input type="password" id="weatherApiKey" value="{{ settings.get('weather_api_key', '') }}" placeholder="Enter your OpenWeatherMap API key" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%; max-width: 500px; font-family: monospace;">
                <button onclick="saveWeatherApiKey()" style="margin-top: 0.5rem; padding: 0.5rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üíæ Save API Key</button>
                <p style="color: #666; margin-top: 0.5rem; font-size: 0.85rem;">
                    This API key will be used to fetch weather data for zip code <strong>{{ zip_code or '02720' }}</strong>.
                </p>
            </div>
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 6px; border: 1px solid #ddd;">
                <label for="weatherStationUrl" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Weather Station URL:</label>
                <input type="url" id="weatherStationUrl" value="{{ settings.get('weather_station_url', 'https://www.wunderground.com/weather/us/ma/fall-river') }}" placeholder="https://www.wunderground.com/weather/us/ma/fall-river" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%; max-width: 500px; font-family: monospace; background: white;">
                <button onclick="saveWeatherStationUrl()" style="margin-top: 0.5rem; padding: 0.5rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üíæ Save Weather URL</button>
            </div>
        </div>

        <div class="settings-section" style="margin-top: 2rem;">
            <h3>AI Filtering</h3>
            <div style="background: #e3f2fd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #2196f3;">
                <p style="margin: 0; color: #1565c0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>AI Relevance Checking:</strong> Uses AI to verify articles are truly about Fall River.
                </p>
            </div>
            <div class="toggle-switch">
                <label>Enable AI Filtering:</label>
                <label class="switch">
                    <input type="checkbox" id="aiFilteringSettings" {{ 'checked' if settings.get('ai_filtering_enabled') == '1' else '' }}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Zip Code Management</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                Enable zip codes to get pre-generated static pages.
            </p>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="newZipCode" placeholder="Enter zip code (e.g., 02720)" pattern="[0-9]{5}" maxlength="5" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 200px; margin-right: 0.5rem;">
                <button onclick="addZipCode()" style="padding: 0.5rem 1rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Add Zip Code</button>
            </div>
            <div id="enabledZipsList" style="display: flex; flex-wrap: gap: 0.5rem; margin-top: 1rem;">
                {% if enabled_zips %}
                    {% for zip in enabled_zips %}
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: #e8f5e9; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #4caf50;">
                        <span style="font-weight: 600;">{{ zip }}</span>
                        <button class="remove-zip-btn" data-zip="{{ zip }}" style="background: #f44336; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.5rem; cursor: pointer;">Remove</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #999; font-style: italic;">No zip codes enabled. Add one to get started.</p>
                {% endif %}
            </div>
        </div>

        <div class="settings-section" style="margin-top: 2rem;">
            <h3>System Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Version:</span>
                    <span class="info-value">{{ version }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Generated:</span>
                    <span class="info-value">{{ last_regeneration or 'Never' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Initialize tab-specific loading
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab') || 'articles';

    // Load data for the active tab
    switch(activeTab) {
        case 'trash':
            if (window.loadTrash) {
                setTimeout(() => window.loadTrash(), 100);
            }
            break;
        case 'categories':
            setTimeout(() => loadCategoryStats(), 100);
            break;
        case 'relevance':
            if (window.loadBayesianStats) {
                setTimeout(() => window.loadBayesianStats(), 100);
            }
            break;
    }
});




// Article management functions are now handled in admin.js
</script>
{% endblock %}