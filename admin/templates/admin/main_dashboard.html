<!DOCTYPE html>
<html>
<head>
    <title>Main Admin - Fall River News</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #0078d4; }
        .zip-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .zip-card { padding: 15px; background: #e3f2fd; border-radius: 4px; text-align: center; }
        .zip-card a { color: #0078d4; text-decoration: none; font-weight: bold; }
        .zip-card a:hover { text-decoration: underline; }
        .actions { margin: 20px 0; padding: 15px; background: #fff3e0; border-radius: 4px; }
        button { padding: 10px 20px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #005a9e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Main Admin Dashboard</h1>
        <p>Logged in as: <strong>admin</strong> | <a href="{{ url_for('admin.logout') }}">Logout</a></p>
        
        <div class="actions">
            <h2>Global Actions</h2>
            <button onclick="regenerateAll()">Regenerate All Websites</button>
            <button onclick="regenerateSelected()">Regenerate Selected Zip</button>
        </div>
        
        <!-- Phase 9: Zip Pin Editability Toggle -->
        <div class="actions" style="margin-top: 2rem; border: 2px solid #0078d4;">
            <h2 style="color: #0078d4; margin-bottom: 1rem;">Zip Pin Settings</h2>
            <div style="padding: 1rem; background: #e3f2fd; border-radius: 4px;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="zipPinEditable" onchange="toggleZipPinEditable()" style="width: 24px; height: 24px; cursor: pointer;">
                    <span style="font-size: 1.1em; font-weight: bold;">Enable Zip Pin Editing</span>
                </label>
                <p style="margin-top: 0.75rem; font-size: 1em; color: #333; line-height: 1.5;">
                    When enabled, the purple zip pin badge on the frontend becomes clickable, allowing users to change their zip code and view news for different areas.
                </p>
                <p style="margin-top: 0.5rem; font-size: 0.9em; color: #666; font-style: italic;">
                    Current status: <span id="zipPinStatus" style="font-weight: bold;">Loading...</span>
                </p>
            </div>
        </div>
        
        <h2>Zip Code Admins ({{ zip_codes|length }} total)</h2>
        
        {% if sticky_zips %}
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #0078d4; margin-bottom: 1rem;">⭐ Sticky Zip Codes</h3>
            <div class="zip-list">
                {% for zip_code in sticky_zips %}
                {% if zip_code in zip_codes %}
                <div class="zip-card" style="background: #fff3e0; border: 2px solid #ff9800;">
                    <a href="{{ url_for('admin.dashboard', zip_code=zip_code) }}">⭐ Zip {{ zip_code }}</a>
                    <button class="remove-sticky-btn" data-zip-code="{{ zip_code }}" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #d32f2f; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">Remove</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="zip-list">
            {% for zip_code in zip_codes %}
            {% set is_sticky = zip_code in sticky_zips %}
            <div class="zip-card" {% if is_sticky %}style="background: #fff3e0; border: 2px solid #ff9800;"{% endif %}>
                <a href="{{ url_for('admin.dashboard', zip_code=zip_code) }}">{% if is_sticky %}⭐ {% endif %}Zip {{ zip_code }}</a>
                <button class="toggle-sticky-btn" data-zip-code="{{ zip_code }}" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: {% if is_sticky %}#d32f2f{% else %}#4caf50{% endif %}; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                    {% if is_sticky %}Remove from{% else %}Add to{% endif %} Sticky
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
        // Phase 9: Load zip pin setting on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadZipPinSetting();
        });
        
        function loadZipPinSetting() {
            fetch('/admin/api/get-zip-pin-setting')
                .then(r => r.json())
                .then(data => {
                    if (data.success !== false) {
                        const checkbox = document.getElementById('zipPinEditable');
                        const status = document.getElementById('zipPinStatus');
                        if (checkbox) {
                            checkbox.checked = data.editable || false;
                        }
                        if (status) {
                            status.textContent = data.editable ? 'ENABLED' : 'DISABLED';
                            status.style.color = data.editable ? '#4caf50' : '#d32f2f';
                        }
                    }
                })
                .catch(err => {
                    console.error('Error loading zip pin setting:', err);
                    const status = document.getElementById('zipPinStatus');
                    if (status) {
                        status.textContent = 'Error loading';
                        status.style.color = '#d32f2f';
                    }
                });
        }
        
        function toggleZipPinEditable() {
            const checkbox = document.getElementById('zipPinEditable');
            const status = document.getElementById('zipPinStatus');
            const enabled = checkbox.checked;
            
            fetch('/admin/api/toggle-zip-pin-editable', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (status) {
                        status.textContent = data.editable ? 'ENABLED' : 'DISABLED';
                        status.style.color = data.editable ? '#4caf50' : '#d32f2f';
                    }
                    alert(data.message || `Zip pin editing ${data.editable ? 'enabled' : 'disabled'}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to update setting'));
                    checkbox.checked = !enabled; // Revert checkbox
                    if (status) {
                        status.textContent = enabled ? 'DISABLED' : 'ENABLED';
                        status.style.color = enabled ? '#d32f2f' : '#4caf50';
                    }
                }
            })
            .catch(err => {
                console.error('Error toggling zip pin setting:', err);
                alert('Error updating setting');
                checkbox.checked = !enabled; // Revert checkbox
                if (status) {
                    status.textContent = enabled ? 'DISABLED' : 'ENABLED';
                    status.style.color = enabled ? '#d32f2f' : '#4caf50';
                }
            });
        }
        
        function regenerateAll() {
            if (confirm('Regenerate websites for all zip codes?')) {
                fetch('{{ url_for("admin.regenerate_all_websites_api") }}', {method: "POST"})
                    .then(r => r.json())
                    .then(data => alert(data.message || 'Regeneration started'));
            }
        }
        function regenerateSelected() {
            const zip = prompt('Enter zip code to regenerate:');
            if (zip && /^\d{5}$/.test(zip)) {
                fetch('{{ url_for("admin.regenerate_website_api") }}?zip=' + encodeURIComponent(zip), {method: "POST"})
                    .then(r => r.json())
                    .then(data => alert(data.message || 'Regeneration started'));
            }
        }
    </script>
</body>
</html>

