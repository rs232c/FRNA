{% extends "admin/base.html" %}

<!-- #region agent log - Hypothesis E: Jinja2 template start -->
<script>
fetch('http://127.0.0.1:7242/ingest/9497b7ee-78b4-45c5-99fd-3c5b05e85c0a', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        id: 'log_' + Date.now() + '_jinja2_start',
        timestamp: Date.now(),
        location: 'admin/templates/admin/settings.html:jinja_start',
        message: 'Jinja2 template processing started',
        data: {
            zip_code_raw: '{{ zip_code }}',
            active_tab_raw: '{{ active_tab }}',
            settings_raw: '{{ settings }}'
        },
        sessionId: 'debug-session',
        runId: 'run1',
        hypothesisId: 'E'
    })
}).catch(() => {});
</script>
<!-- #endregion -->

{% block title %}Settings{% if zip_code %} - Zip {{ zip_code }}{% endif %}{% endblock %}

{% block content %}
<!-- #region agent log - Hypothesis C: Template rendering -->
<script>
fetch('http://127.0.0.1:7242/ingest/9497b7ee-78b4-45c5-99fd-3c5b05e85c0a', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        id: 'log_' + Date.now() + '_template_rendered',
        timestamp: Date.now(),
        location: 'admin/templates/admin/settings.html:render_start',
        message: 'Settings template rendered - block content started',
        data: {
            zip_code: '{{ zip_code }}',
            active_tab: '{{ active_tab }}',
            settings_available: '{{ settings is not none }}'
        },
        sessionId: 'debug-session',
        runId: 'run1',
        hypothesisId: 'C'
    })
}).catch(() => {});
</script>
<!-- #endregion -->

<div id="settingsTab" class="tab-content">
    <div class="settings-container" style="max-width: 700px; margin-left: auto; margin-right: auto;">
        <h2 style="margin-bottom: 1.5rem;">Settings</h2>

        <div class="settings-section">
            <h3>Website Regeneration</h3>
            <div class="settings-controls">
                <button onclick="regenerateWebsite()" style="margin-right: 1rem;">Regenerate Website</button>
                <button onclick="regenerateAll()" style="background: #ff9800; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">ðŸ”„ Regenerate All (Fresh Data)</button>
            </div>
            <p style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
                <strong>Regenerate Website:</strong> Regenerates the website using existing articles in the database.<br>
                <strong>Regenerate All:</strong> Fetches fresh data from all sources and regenerates the entire website. This may take several minutes.
            </p>
            
            <div style="margin-top: 1.5rem;">
                <label for="regenerateInterval" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Regenerate Interval (minutes):</label>
                <input type="number" id="regenerateInterval" min="1" max="1440" value="{{ settings.get('regenerate_interval', '10') }}" 
                       style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 150px;">
                <p style="color: #666; margin-top: 0.25rem; font-size: 0.85rem;">
                    <strong>Full Cycle Interval:</strong> How often to run the complete aggregation cycle (fetch articles + regenerate website). 
                    This is the main scheduler interval. Default: 10 minutes.
                </p>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <label for="sourceFetchInterval" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Source Fetch Interval (minutes):</label>
                <input type="number" id="sourceFetchInterval" min="1" max="1440" value="{{ settings.get('source_fetch_interval', '10') }}" 
                       style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 150px;">
                <p style="color: #666; margin-top: 0.25rem; font-size: 0.85rem;">
                    <strong>Ingestion Throttle:</strong> How often to fetch articles from sources. Within each cycle, sources won't be fetched again if they were fetched within this interval. 
                    This prevents over-fetching when cycles run frequently. Default: 10 minutes.
                </p>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <button onclick="saveRegenerateSettings()" style="padding: 0.5rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 1rem;">ðŸ’¾ Save All Settings</button>
                <p style="color: #666; margin-top: 0.5rem; font-size: 0.85rem; font-style: italic;">
                    Note: Changes take effect on the next scheduled cycle. Restart the main.py process to apply immediately.
                </p>
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Display Settings</h3>
            <div class="toggle-switch">
                <label title="Allow Hotlinked Images â€“ turns on/off external photos (obituaries, news sites)">Allow Hotlinked Images:</label>
                <label class="switch">
                    <input type="checkbox" id="showImagesSettings" {{ 'checked' if settings.get('show_images') == '1' else '' }}>
                    <span class="slider"></span>
                </label>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.75rem; line-height: 1.4;">
                Toggling this option changes how the static site renders images, so you must regenerate the website for the new state to appear.
                Regeneration rebuilds the cached pages (source fetches are intentionally throttled to ~5 minutes) and serves the updated markup, so please wait for the process to complete before checking the frontend.
            </p>
        </div>
        
        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Weather API Configuration</h3>
            <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #856404; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Get your free API key:</strong> Visit <a href="https://openweathermap.org/api" target="_blank" style="color: #0066cc;">https://openweathermap.org/api</a> and sign up for a free account. 
                    The free tier provides 1000 calls/day, which is more than enough for weather updates.
                </p>
            </div>
            <div style="margin-top: 1rem;">
                <label for="weatherApiKey" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">OpenWeatherMap API Key:</label>
                <input type="password" id="weatherApiKey" 
                       value="{{ settings.get('weather_api_key', '') }}" 
                       placeholder="Enter your OpenWeatherMap API key"
                       style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%; max-width: 500px; font-family: monospace;">
                <button onclick="saveWeatherApiKey()" 
                        style="margin-top: 0.5rem; padding: 0.5rem 1.5rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    ðŸ’¾ Save API Key
                </button>
                <p style="color: #666; margin-top: 0.5rem; font-size: 0.85rem;">
                    This API key will be used to fetch weather data for zip code <strong>{{ zip_code or '02720' }}</strong>. 
                    After saving, regenerate the website to apply the changes.
                </p>
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 2rem;">
            <h3>Hard Filter Keywords</h3>
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                Articles must contain at least ONE of these keywords in the title or summary to be accepted. 
                If no keywords match, the article is instantly rejected (score = 0).
            </p>
            <div id="hardFilterKeywords" style="background: #252525; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; min-height: 100px;">
                <p style="color: #888; font-style: italic;">Loading keywords...</p>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <input type="text" id="newHardFilterKeyword" placeholder="Enter keyword (e.g., Fall River)" 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #404040; border-radius: 4px; background: #1a1a1a; color: white; max-width: 300px;">
                <button onclick="addHardFilterKeyword()" 
                        style="padding: 0.5rem 1.5rem; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    âž• Add Keyword
                </button>
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 2rem;">
            <h3>AI Filtering</h3>
            <div style="background: #e3f2fd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #2196f3;">
                <p style="margin: 0; color: #1565c0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>AI Relevance Checking:</strong> Uses AI to verify articles are truly about Fall River before ingestion. 
                    Requires OpenAI API key (set OPENAI_API_KEY environment variable). 
                    If no API key, uses enhanced heuristic-based filtering.
                </p>
            </div>
            <div class="toggle-switch">
                <label>Enable AI Filtering:</label>
                <label class="switch">
                    <input type="checkbox" id="aiFilteringSettings" {{ 'checked' if settings.get('ai_filtering_enabled') == '1' else '' }}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 2rem;">
            <h3>System Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Version:</span>
                    <span class="info-value">{{ version }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Generated:</span>
                    <span class="info-value">{{ last_regeneration or 'Never' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // #region agent log
    // Log checkbox state on page load
    (function() {
        const checkbox = document.getElementById('showImagesSettings');
        if (checkbox) {
            console.log('Settings page loaded - checkbox state:', checkbox.checked);
            fetch('http://127.0.0.1:7242/ingest/9497b7ee-78b4-45c5-99fd-3c5b05e85c0a', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sessionId: 'debug-session',
                    runId: 'settings-page-load',
                    hypothesisId: 'K',
                    location: 'admin/templates/admin/settings.html:193',
                    message: 'Settings page loaded - checkbox initial state',
                    data: {checkboxChecked: checkbox.checked, checkboxId: checkbox.id},
                    timestamp: Date.now()
                })
            }).catch(() => {});
        }
    })();
    // #endregion
    
    function checkAndTriggerRegeneration() {
        // Get zip code from URL - use same function as admin.js
        let zipCode;
        if (typeof getZipCodeFromUrl === 'function') {
            zipCode = getZipCodeFromUrl();
        } else {
            // Fallback: extract from URL path
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'admin' && pathParts[2] && pathParts[2].length === 5) {
                let isAllDigits = true;
                for (let i = 0; i < pathParts[2].length; i++) {
                    if (pathParts[2].charAt(i) < '0' || pathParts[2].charAt(i) > '9') {
                        isAllDigits = false;
                        break;
                    }
                }
                if (isAllDigits) {
                    zipCode = pathParts[2];
                }
            }
        }
        if (!zipCode) return;
        
        // Check if regeneration is needed by calling backend
        fetch('/admin/api/check-regeneration-needed', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        })
        .then(r => r.json())
        .then(data => {
            if (data.needs_regeneration) {
                console.log('Auto-triggering regeneration (interval elapsed)...');
                // Silently trigger regeneration without user confirmation
                fetch('/admin/api/regenerate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({ zip_code: zipCode, force_refresh: false })
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        console.log('Auto-regeneration triggered successfully');
                    }
                })
                .catch(e => console.error('Auto-regeneration error:', e));
            }
        })
        .catch(e => console.error('Error checking regeneration status:', e));
    }
    
    // Check on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAndTriggerRegeneration);
    } else {
        checkAndTriggerRegeneration();
    }
    
    // Check every 5 minutes
    setInterval(checkAndTriggerRegeneration, 300000); // 5 minutes
})();

function saveWeatherApiKey() {
    const apiKey = document.getElementById('weatherApiKey').value.trim();
    const zipCode = '{{ zip_code or "02720" }}';
    
    fetch('/admin/api/save-weather-api-key', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({
            zip_code: zipCode,
            api_key: apiKey
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('âœ“ Weather API key saved successfully! Regenerate the website to apply changes.');
        } else {
            alert('âœ— Error saving API key: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(e => {
        console.error('Error saving weather API key:', e);
        alert('âœ— Error saving API key. Check console for details.');
    });
}
</script>
{% endblock %}

